<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spin Wheel Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #F0F0F7;
            --text-color: #1c1c1e;
            --card-bg-color: white;
            --input-bg-color: white;
            --input-border-color: #C6C6C8;
            --btn-primary-bg: #007AFF;
            --btn-primary-text: white;
            --btn-primary-hover-bg: #0056b3;
            --btn-secondary-bg: #E5E5EA;
            --btn-secondary-text: #007AFF;
            --btn-secondary-border: #007AFF;
            --btn-secondary-hover-bg: #DCDCE0;
            --btn-danger-bg: #FF3B30;
            --btn-danger-text: white;
            --btn-danger-hover-bg: #D92C23;
            --modal-content-bg: #fefefe;
            --text-gray-500: #8E8E93;
            --text-gray-700: #3A3A3C;
            --text-gray-800: #1C1C1E;
            --placeholder-wheel-bg: #E5E5EA;
            --title-text-color: var(--text-gray-800); 
            --pricing-text-color: var(--text-gray-700);
            /* --chaturbate-text-color: var(--text-gray-500); Removed as text is removed */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overscroll-behavior-y: contain;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 0.5em auto; 
        }
        canvas {
            display: block;
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 5px 10px rgba(0,0,0,0.05);
        }
        .pointer {
            position: absolute;
            left: 50%; 
            top: -10px; 
            width: 20px;
            height: 30px; 
            background-color: var(--btn-danger-bg);
            clip-path: polygon(50% 100%, 0 0, 100% 0); 
            transform: translateX(-50%);
            z-index: 10;
        }
        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--btn-primary-hover-bg);
        }
        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--btn-secondary-border);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: var(--btn-secondary-hover-bg);
        }
        .btn-danger {
            background-color: var(--btn-danger-bg);
            color: var(--btn-danger-text);
        }
        .btn-danger:hover {
            background-color: var(--btn-danger-hover-bg);
        }
        .input-field {
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color); 
        }
        .input-field::placeholder {
            color: var(--text-gray-500);
        }
        .input-field:focus {
            border-color: var(--btn-primary-bg);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--btn-primary-bg) 20%, transparent);
        }
        .card {
            background-color: var(--card-bg-color);
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: background-color 0.3s ease;
        }
        .card h2, .card p, .card span, .card div label, .card select {
             color: var(--text-color);
        }
        .card .text-gray-500 { color: var(--text-gray-500) !important; }
        .card .text-gray-700 { color: var(--text-gray-700) !important; }


        .winner-item {
            border-bottom: 1px solid var(--input-border-color); 
        }
        .winner-item:last-child {
            border-bottom: none;
        }
        .title-text { color: var(--title-text-color); } 
        .pricing-text { color: var(--pricing-text-color); }
        /* .chaturbate-note { color: var(--chaturbate-text-color); } Removed as text is removed */
        .text-gray-800 { color: var(--text-gray-800); }
        .text-gray-700 { color: var(--text-gray-700); }
        .text-gray-600 { color: var(--text-gray-500); } 
        .text-gray-500 { color: var(--text-gray-500); }


        @media (max-width: 768px) { 
            .main-app-container {
                flex-direction: column;
                align-items: center;
            }
            .winners-log-container {
                width: 100%;
                max-width: 448px; 
                order: -1; 
                margin-bottom: 1.5rem; 
            }
            .wheel-and-controls-container {
                width: 100%;
            }
            .wheel-container {
                width: 85vw; 
                height: 85vw; 
                max-width: 320px; 
                max-height: 320px;
            }
            .pointer {
                width: 15px;
                height: 25px;
                top: -8px; 
            }
            .theme-selector-container {
                position: relative; 
                top: auto;
                right: auto;
                margin: 0 auto 1rem auto; 
                width: fit-content;
            }
        }
        .modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); 
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--modal-content-bg);
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            color: var(--text-color); 
        }
        .modal-content h3, .modal-content p {
            color: var(--text-color);
        }
        .close-button { 
            color: #aaa;
            position: absolute; 
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--text-color); 
        }

        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 9999;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00; 
            opacity: 0.7;
            animation: fall 3s linear forwards;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        .theme-selector-container { 
            position: absolute; 
            top: 1rem; 
            right: 1rem; 
            z-index: 20;
        }
        .theme-selector-container label {
            font-size: 0.8rem; 
            margin-right: 0.25rem;
        }
        .theme-selector-container select {
            font-size: 0.8rem; 
            padding: 0.25rem 0.5rem; 
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div id="confetti-container"></div>

    <div class="theme-selector-container card p-1.5">
        <label for="themeSelector" class="text-sm font-medium mr-1">Theme:</label>
        <select id="themeSelector" class="input-field p-1 rounded-md text-xs focus:outline-none">
            <option value="light-mode">Light Mode</option> 
            <option value="dark-mode">Dark Mode</option>
            <option value="vibrant">Vibrant</option>
        </select>
    </div>

    <div class="main-app-container flex flex-row min-h-full pt-8 md:pt-4">
        <div class="winners-log-container w-full md:w-1/3 lg:w-1/4 p-2 md:pr-4">
            <div id="winnersSection" class="card p-6 space-y-3 h-full">
                <h2 class="text-xl font-semibold text-gray-700">üèÜ Winners Log üèÜ</h2>
                <div id="winnersList" class="space-y-2 max-h-[calc(100vh-200px)] md:max-h-[calc(100vh-150px)] overflow-y-auto">
                    </div>
                <button id="clearWinnersButton" class="btn-secondary w-full text-sm py-2 px-4 rounded-lg mt-auto">Clear Winners Log</button>
            </div>
        </div>

        <div class="wheel-and-controls-container flex-grow p-2 flex flex-col items-center space-y-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-center title-text mt-8 md:mt-0">Spin & Win!</h1>
            <div class="text-center my-2">
                <p class="text-lg font-semibold pricing-text">Spin Cost: 200 Tokens</p>
                </div>

            <div class="wheel-container">
                <canvas id="wheelCanvas"></canvas>
                <div class="pointer"></div>
            </div>

            <button id="spinButton" class="btn-primary font-semibold py-3 px-8 rounded-lg text-lg shadow-md active:scale-95 transform transition-transform">
                Spin the Wheel!
            </button>

            <div class="w-full max-w-md space-y-6"> <div class="card p-6 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-700">Customize Prizes</h2>
                    <div class="flex space-x-2">
                        <input type="text" id="segmentInput" placeholder="Enter prize name" class="input-field flex-grow p-3 rounded-lg focus:outline-none">
                        <button id="addSegmentButton" class="btn-secondary font-medium py-3 px-5 rounded-lg whitespace-nowrap">Add Prize</button>
                    </div>
                    <div id="segmentList" class="space-y-2 max-h-40 overflow-y-auto">
                        </div>
                     <div class="flex space-x-2 mt-2">
                        <button id="saveConfigButton" class="btn-secondary text-sm py-2 px-4 rounded-lg w-1/2">Save Prizes</button>
                        <button id="loadConfigButton" class="btn-secondary text-sm py-2 px-4 rounded-lg w-1/2">Load Prizes</button>
                    </div>
                    <button id="clearSegmentsButton" class="btn-danger w-full font-medium py-2 px-4 rounded-lg mt-2 text-sm">Clear All Prizes</button>
                </div>
            </div>
        </div>
    </div>


    <div id="winnerModal" class="modal">
        <div class="modal-content p-6 space-y-4 relative"> <span class="close-button" id="closeWinnerModalButton">&times;</span>
            <h3 class="text-2xl font-semibold">Congratulations!</h3>
            <p id="prizeWonText" class="text-lg"></p>
            <input type="text" id="winnerNameInput" placeholder="Enter winner's name" class="input-field w-full p-3 rounded-lg focus:outline-none">
            <button id="confirmWinnerButton" class="btn-primary w-full font-semibold py-3 px-6 rounded-lg">Log Winner</button>
        </div>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content p-6 space-y-4">
            <h3 id="confirmationTitle" class="text-xl font-semibold">Confirm Action</h3>
            <p id="confirmationMessage" class="text-base"></p>
            <div class="flex justify-end space-x-3 pt-3">
                <button id="confirmCancelButton" class="btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirmActionButton" class="btn-danger py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <p id="messageArea" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 text-sm text-gray-500 text-center h-5 z-10"></p>

    <script>
        // --- DOM Elements ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spinButton');
        const segmentInput = document.getElementById('segmentInput');
        const addSegmentButton = document.getElementById('addSegmentButton');
        const segmentList = document.getElementById('segmentList');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const loadConfigButton = document.getElementById('loadConfigButton');
        const clearSegmentsButton = document.getElementById('clearSegmentsButton');
        
        const winnerModal = document.getElementById('winnerModal');
        const closeWinnerModalButton = document.getElementById('closeWinnerModalButton');
        const prizeWonText = document.getElementById('prizeWonText');
        const winnerNameInput = document.getElementById('winnerNameInput');
        const confirmWinnerButton = document.getElementById('confirmWinnerButton');
        
        const winnersSection = document.getElementById('winnersSection');
        const winnersList = document.getElementById('winnersList');
        const clearWinnersButton = document.getElementById('clearWinnersButton');
        const messageArea = document.getElementById('messageArea');

        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancelButton = document.getElementById('confirmCancelButton');
        const confirmActionButton = document.getElementById('confirmActionButton');
        let currentConfirmAction = null;

        const themeSelector = document.getElementById('themeSelector');
        const confettiContainer = document.getElementById('confetti-container');


        // --- State ---
        let segments = []; 
        let currentAngle = 0; 
        let spinTimeout = null;
        let isSpinning = false;
        let spinAngleStart = 0; 
        let spinTime = 0;
        let spinTimeTotal = 0;
        let currentPrize = null; 
        let currentPrizeIndex = -1; // To store the index of the current prize for removal
        let winners = []; 

        // --- Audio (Tone.js) ---
        let tickSynth, winSynth;
        function initAudio() {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            if (!tickSynth) {
                tickSynth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.05 }
                }).toDestination();
            }
            if (!winSynth) {
                winSynth = new Tone.PluckSynth({
                    attackNoise: 1,
                    dampening: 4000,
                    resonance: 0.7
                }).toDestination();
            }
        }
        document.body.addEventListener('click', initAudio, { once: true });


        // --- Wheel Colors (iOS Inspired Palette) ---
        const baseColors = [
            "#007AFF", "#34C759", "#FF9500", "#AF52DE", "#5856D6",
            "#FF2D55", "#FFCC00", "#8E8E93", "#5AC8FA", "#FF6B22",
        ];

        function getSegmentColor(index) {
            return baseColors[index % baseColors.length];
        }

        // --- Theming ---
        const themes = {
            "light-mode": { 
                "--bg-color": "#F0F0F7", "--text-color": "#1c1c1e", "--card-bg-color": "white",
                "--input-bg-color": "white", "--input-border-color": "#C6C6C8", "--btn-primary-bg": "#007AFF",
                "--btn-primary-text": "white", "--btn-primary-hover-bg": "#0056b3", "--btn-secondary-bg": "#E5E5EA",
                "--btn-secondary-text": "#007AFF", "--btn-secondary-border": "#007AFF", "--btn-secondary-hover-bg": "#DCDCE0",
                "--btn-danger-bg": "#FF3B30", "--btn-danger-text": "white", "--btn-danger-hover-bg": "#D92C23",
                "--modal-content-bg": "#fefefe", "--text-gray-500": "#8E8E93", "--text-gray-700": "#3A3A3C",
                "--text-gray-800": "#1C1C1E", "--placeholder-wheel-bg": "#E5E5EA", "--title-text-color": "#EF4444", 
                "--pricing-text-color": "#1C1C1E", 
            },
            "dark-mode": {
                "--bg-color": "#1C1C1E", "--text-color": "#FFFFFF", "--card-bg-color": "#2C2C2E",
                "--input-bg-color": "#3A3A3C", "--input-border-color": "#545458", "--btn-primary-bg": "#0A84FF",
                "--btn-primary-text": "white", "--btn-primary-hover-bg": "#0060df", "--btn-secondary-bg": "#3A3A3C",
                "--btn-secondary-text": "#0A84FF", "--btn-secondary-border": "#0A84FF", "--btn-secondary-hover-bg": "#545458",
                "--btn-danger-bg": "#FF453A", "--btn-danger-text": "white", "--btn-danger-hover-bg": "#d9322b",
                "--modal-content-bg": "#2C2C2E", "--text-gray-500": "#8D8D93", "--text-gray-700": "#AEAEB2",
                "--text-gray-800": "#F2F2F7", "--placeholder-wheel-bg": "#3A3A3C", "--title-text-color": "#F87171", 
                "--pricing-text-color": "#F2F2F7", 
            },
            "vibrant": {
                "--bg-color": "#E0F7FA", "--text-color": "#004D40", "--card-bg-color": "#FFFFFF",
                "--input-bg-color": "#FFFFFF", "--input-border-color": "#B2DFDB", "--btn-primary-bg": "#FF6F00",
                "--btn-primary-text": "white", "--btn-primary-hover-bg": "#E65100", "--btn-secondary-bg": "#FFF9C4",
                "--btn-secondary-text": "#FF6F00", "--btn-secondary-border": "#FF6F00", "--btn-secondary-hover-bg": "#FFF59D",
                "--btn-danger-bg": "#D32F2F", "--btn-danger-text": "white", "--btn-danger-hover-bg": "#B71C1C",
                "--modal-content-bg": "#FFFDE7", "--text-gray-500": "#4E342E", "--text-gray-700": "#004D40",
                "--text-gray-800": "#004D40", "--placeholder-wheel-bg": "#B2DFDB", "--title-text-color": "#DC2626", 
                "--pricing-text-color": "#004D40", 
            }
        };

        function applyTheme(themeName) {
            const theme = themes[themeName];
            for (const key in theme) {
                document.documentElement.style.setProperty(key, theme[key]);
            }
            localStorage.setItem('selectedTheme', themeName);
            document.querySelector('.title-text').style.color = theme['--title-text-color'];
            document.querySelector('.pricing-text').style.color = theme['--pricing-text-color'];

            drawWheel();
            renderSegmentList(); 
            renderWinnersList(); 
        }

        themeSelector.addEventListener('change', (e) => applyTheme(e.target.value));
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'vibrant'; 
            themeSelector.value = savedTheme;
            applyTheme(savedTheme);
        }


        // --- Canvas Sizing ---
        function resizeCanvas() {
            const container = document.querySelector('.wheel-container');
            let size = Math.min(container.clientWidth, container.clientHeight);
            size = Math.max(size, 20); 
            canvas.width = size;
            canvas.height = size;
            drawWheel();
        }
        window.addEventListener('resize', resizeCanvas);
        

        // --- Wheel Drawing ---
        function drawWheel() {
            const numSegments = segments.length;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.max(1, canvas.width / 2 - 5); 

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (numSegments === 0) {
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--placeholder-wheel-bg').trim();
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI); 
                ctx.fill();
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-gray-500').trim();
                ctx.font = `bold ${Math.max(12, canvas.width * 0.05)}px Inter`; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Add prizes to spin!', centerX, centerY);
                return;
            }

            const arcSize = (2 * Math.PI) / numSegments;
            const baseFontSize = radius * 0.1; 
            const adjustedFontSize = Math.max(10, Math.min(18, baseFontSize * (6 / Math.max(numSegments, 4)))); 
            ctx.font = `bold ${adjustedFontSize}px Inter`; 
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';

            for (let i = 0; i < numSegments; i++) {
                const angle = currentAngle + i * arcSize;
                ctx.fillStyle = segments[i].color;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, angle, angle + arcSize);
                ctx.closePath();
                ctx.fill();

                ctx.save();
                ctx.fillStyle = "white"; 

                ctx.translate(centerX, centerY);
                ctx.rotate(angle + arcSize / 2); 
                
                const text = segments[i].text;
                const maxTextWidth = radius * 0.75; 
                let displayText = text;
                if (ctx.measureText(text).width > maxTextWidth) {
                    while(ctx.measureText(displayText + '...').width > maxTextWidth && displayText.length > 1) {
                        displayText = displayText.slice(0, -1);
                    }
                    displayText += '...';
                }
                ctx.fillText(displayText, radius * 0.6, 0); 
                ctx.restore();
            }
        }

        // --- Spinning Logic ---
        function rotateWheel() {
            spinTime += 30; 
            if (spinTime >= spinTimeTotal) {
                stopRotateWheel();
                return;
            }
            const totalRotationDegrees = spinAngleStart; 
            const easedAngle = easeOutCubic(spinTime, 0, totalRotationDegrees, spinTimeTotal);
            currentAngle = (initialAngleForSpin + (easedAngle * Math.PI / 180)) % (2 * Math.PI);

            drawWheel();

            if (tickSynth && Math.random() < 0.25) { 
                 try { tickSynth.triggerAttackRelease("C5", "32n", Tone.now() + 0.01); } catch(e) { console.warn("Audio error on tick:", e)}
            }
            spinTimeout = requestAnimationFrame(rotateWheel);
        }
        
        let initialAngleForSpin = 0; 

        function spin() {
            if (isSpinning || segments.length < 2) {
                showMessage(segments.length < 2 ? "Add at least 2 prizes to spin!" : "Already spinning!");
                return;
            }
            initAudio(); 
            isSpinning = true;
            spinButton.disabled = true;
            showMessage("Spinning...");

            initialAngleForSpin = currentAngle; 
            spinAngleStart = (Math.random() * 5 + 5) * 360; 
            spinTime = 0;
            spinTimeTotal = Math.random() * 2000 + 5000; 
            
            if (tickSynth) {
                try { tickSynth.triggerAttackRelease("E5", "16n", Tone.now()); } catch(e) { console.warn("Audio error on spin start:", e)}
            }
            rotateWheel();
        }

        function stopRotateWheel() {
            cancelAnimationFrame(spinTimeout);
            isSpinning = false;
            // Keep spin button disabled until explicitly re-enabled after modal or if not enough segments
            // spinButton.disabled = false; 

            const pointerRefAngleRad = Math.PI / 2; 
            let effectiveAngleRad = pointerRefAngleRad - currentAngle; 
            effectiveAngleRad = ((effectiveAngleRad % (2 * Math.PI)) + (2 * Math.PI)) % (2 * Math.PI);

            if (segments.length > 0) {
                const arcSizeRad = (2 * Math.PI) / segments.length;
                currentPrizeIndex = Math.floor(effectiveAngleRad / arcSizeRad); // Store index
                currentPrize = segments[currentPrizeIndex]; // Store the prize object
                
                showMessage(`Prize: ${currentPrize.text}!`);
                launchConfetti(); 

                if (winSynth) {
                    try { 
                        winSynth.triggerAttackRelease("C4", "0.5s", Tone.now()); 
                        setTimeout(() => {
                            winSynth.triggerAttackRelease("G4", "0.4s", Tone.now() + 0.15);
                            winSynth.triggerAttackRelease("E5", "0.3s", Tone.now() + 0.3);
                        }, 100);
                    } catch(e) { console.warn("Audio error on win:", e)}
                }
                
                prizeWonText.textContent = `The prize is: ${currentPrize.text}!`; 
                prizeWonText.classList.remove('text-red-500'); 
                winnerNameInput.value = '';
                winnerModal.style.display = "flex";
                winnerNameInput.focus();
                // Prize is NOT removed here. It's removed in logWinner.
                // Spin button state will be handled after modal interaction or if modal is closed.
                if (segments.length < 2) { // Check current segments before modal
                    spinButton.disabled = true;
                } else {
                    spinButton.disabled = false;
                }


            } else {
                showMessage("No prizes to win.");
                spinButton.disabled = true; 
            }
        }

        function easeOutCubic(t, b, c, d) { 
            t /= d;
            t--;
            return c * (t * t * t + 1) + b;
        }

        // --- Confetti Logic ---
        function launchConfetti() {
            const confettiCount = 100;
            const confettiColors = ['#FF6B6B', '#FFD166', '#06D6A0', '#118AB2', '#073B4C', ...baseColors]; 

            for (let i = 0; i < confettiCount; i++) {
                const confettiPiece = document.createElement('div');
                confettiPiece.classList.add('confetti');
                confettiPiece.style.left = Math.random() * 100 + 'vw';
                confettiPiece.style.top = -20 + Math.random() * -50 + 'px'; 
                confettiPiece.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confettiPiece.style.transform = `rotate(${Math.random() * 360}deg) scale(${Math.random() * 0.5 + 0.5})`;
                confettiPiece.style.animationDelay = Math.random() * 0.5 + 's'; 
                confettiContainer.appendChild(confettiPiece);

                setTimeout(() => {
                    confettiPiece.remove();
                }, 3500); 
            }
        }


        // --- Segment Management ---
        function addSegment() {
            const text = segmentInput.value.trim();
            if (text) {
                if (segments.length >= 20) { 
                    showMessage("Maximum 20 prizes allowed.");
                    return;
                }
                segments.push({ text: text, color: getSegmentColor(segments.length) });
                segmentInput.value = '';
                renderSegmentList();
                drawWheel();
                showMessage(`Prize "${text}" added.`);
                if (segments.length >= 2) { 
                    spinButton.disabled = false;
                }
            } else {
                showMessage("Please enter a prize name.");
            }
        }

        function removeSegment(index) { 
            const removedSegment = segments.splice(index, 1)[0];
            segments.forEach((seg, i) => seg.color = getSegmentColor(i));
            renderSegmentList();
            drawWheel();
            showMessage(`Prize "${removedSegment.text}" removed.`);
            if (segments.length < 2) {
                spinButton.disabled = true;
            }
        }

        function renderSegmentList() {
            segmentList.innerHTML = '';
            const currentTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
            const currentSecondaryBgColor = getComputedStyle(document.documentElement).getPropertyValue('--btn-secondary-bg').trim();
            
            if (segments.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-sm text-gray-500'; 
                p.textContent = 'No prizes added yet.';
                segmentList.appendChild(p);
            }
            segments.forEach((segment, index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 rounded-md text-sm';
                item.style.backgroundColor = currentSecondaryBgColor;

                item.innerHTML = `
                    <span style="display:inline-block; width:12px; height:12px; border-radius:50%; background-color:${segment.color}; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1);"></span>
                    <span class="flex-grow truncate" title="${segment.text}" style="color: ${currentTextColor}">${segment.text}</span>
                    <button class="text-red-500 hover:text-red-700 font-semibold ml-2 text-lg leading-none" data-index="${index}">&times;</button>
                `; 
                item.querySelector('button').addEventListener('click', () => removeSegment(index)); 
                segmentList.appendChild(item);
            });
        }
        
        function clearAllSegments() {
            if (segments.length === 0) {
                showMessage("Prize list is already empty.");
                return;
            }
            showConfirmationModal(
                "Clear All Prizes?",
                "Are you sure you want to remove all prizes? This cannot be undone.",
                () => {
                    segments = [];
                    renderSegmentList();
                    drawWheel();
                    localStorage.removeItem('wheelSegments');
                    showMessage("All prizes cleared.");
                    spinButton.disabled = true; 
                }
            );
        }

        // --- Winner Logging ---
        function logWinner() {
            const winnerName = winnerNameInput.value.trim();
            
            if (!currentPrize || !currentPrize.text) { 
                showMessage("Error logging winner: Prize info missing.", 3000);
                winnerModal.style.display = "none";
                // Re-enable spin button if enough segments, as prize wasn't removed
                if (segments.length >= 2) spinButton.disabled = false; else spinButton.disabled = true;
                return;
            }

            if (!winnerName) { // User did not enter a name
                prizeWonText.textContent = `Please enter winner's name for: ${currentPrize.text}!`;
                prizeWonText.classList.add('text-red-500', 'font-semibold'); 
                winnerNameInput.focus();
                setTimeout(() => {
                    if(currentPrize) prizeWonText.textContent = `The prize is: ${currentPrize.text}!`;
                    prizeWonText.classList.remove('text-red-500', 'font-semibold');
                }, 3000);
                // Prize is NOT removed, re-enable spin button if applicable
                if (segments.length >= 2) spinButton.disabled = false; else spinButton.disabled = true;
                return; // Don't close modal, don't remove prize
            }
            
            // Name entered, proceed to log and remove prize
            winners.unshift({ name: winnerName, prize: currentPrize.text }); 
            renderWinnersList();
            
            // Remove the won segment from the array using the stored index
            if (currentPrizeIndex !== -1 && segments[currentPrizeIndex] && segments[currentPrizeIndex].text === currentPrize.text) {
                segments.splice(currentPrizeIndex, 1);
                // Re-assign colors if segment count changed, for visual consistency
                segments.forEach((seg, i) => seg.color = getSegmentColor(i));
            } else {
                // Fallback: if index is bad, try to find by text (less reliable if duplicate prize names)
                const idxToRemove = segments.findIndex(seg => seg.text === currentPrize.text);
                if (idxToRemove !== -1) {
                    segments.splice(idxToRemove, 1);
                    segments.forEach((seg, i) => seg.color = getSegmentColor(i));
                }
            }
            
            renderSegmentList(); // Update the list of prizes UI
            drawWheel();         // Redraw the wheel without the won prize
            
            winnerModal.style.display = "none";
            showMessage(`${winnerName} won ${currentPrize.text}!`);

            // Reset currentPrize and its index
            currentPrize = null;
            currentPrizeIndex = -1;

            // Check segment count AFTER removal and modal display
            if (segments.length < 2) {
                spinButton.disabled = true;
                if (segments.length === 0) {
                    showMessage("All prizes won! Add more to spin again.", 5000);
                } else {
                    showMessage("Only one prize left. Add more to spin!", 5000);
                }
            } else {
                spinButton.disabled = false; 
            }
        }

        function renderWinnersList() {
            winnersList.innerHTML = '';
            const textGray700 = getComputedStyle(document.documentElement).getPropertyValue('--text-gray-700').trim();
            const textGray600 = getComputedStyle(document.documentElement).getPropertyValue('--text-gray-600').trim();

            if (winners.length > 0) {
                winnersSection.classList.remove('hidden'); 
                winners.forEach(winner => {
                    const item = document.createElement('div');
                    item.className = 'winner-item p-3 text-sm flex justify-between items-center'; 
                    item.innerHTML = `
                        <span class="font-medium truncate pr-2" style="color: ${textGray700}">${winner.name}</span>
                        <span class="truncate text-right" style="color: ${textGray600}">${winner.prize}</span>
                    `;
                    winnersList.appendChild(item);
                });
            } else {
                winnersList.innerHTML = `<p class="text-sm text-gray-500 p-3 text-center">No winners yet!</p>`;
            }
        }
        
        function clearWinnersLog() {
            if (winners.length === 0) {
                showMessage("Winners log is already empty.");
                return;
            }
             showConfirmationModal(
                "Clear Winners Log?",
                "Are you sure you want to clear the entire winners log? This cannot be undone.",
                () => {
                    winners = [];
                    renderWinnersList();
                    showMessage("Winners log cleared.");
                }
            );
        }
        
        // --- Confirmation Modal Logic ---
        function showConfirmationModal(title, message, onConfirm) {
            confirmationTitle.textContent = title;
            confirmationMessage.textContent = message;
            currentConfirmAction = onConfirm; 
            confirmationModal.style.display = "flex";
        }

        confirmCancelButton.addEventListener('click', () => {
            confirmationModal.style.display = "none";
            currentConfirmAction = null;
        });

        confirmActionButton.addEventListener('click', () => {
            if (typeof currentConfirmAction === 'function') {
                currentConfirmAction();
            }
            confirmationModal.style.display = "none";
            currentConfirmAction = null;
        });


        // --- Local Storage for Segments ---
        function saveConfiguration() {
            localStorage.setItem('wheelSegments', JSON.stringify(segments));
            showMessage("Prizes saved!");
        }

        function loadConfiguration() {
            const savedSegments = localStorage.getItem('wheelSegments');
            if (savedSegments) {
                segments = JSON.parse(savedSegments);
                segments.forEach((seg, i) => { 
                    if (!seg.color) seg.color = getSegmentColor(i);
                });
            }
            if (segments.length < 2) {
                spinButton.disabled = true;
            } else {
                spinButton.disabled = false;
            }
        }
        
        // --- Utility ---
        function showMessage(msg, duration = 3000) {
            messageArea.textContent = msg;
            setTimeout(() => {
                if (messageArea.textContent === msg) { 
                    messageArea.textContent = '';
                }
            }, duration);
        }

        // --- Event Listeners ---
        spinButton.addEventListener('click', spin);
        addSegmentButton.addEventListener('click', addSegment);
        segmentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addSegment();
        });
        
        saveConfigButton.addEventListener('click', saveConfiguration);
        loadConfigButton.addEventListener('click', () => {
            loadConfiguration();
            renderSegmentList();
            drawWheel(); 
            showMessage("Prizes loaded!");
        });
        clearSegmentsButton.addEventListener('click', clearAllSegments);

        closeWinnerModalButton.addEventListener('click', () => {
            winnerModal.style.display = "none";
            // If modal is closed without logging winner, ensure spin button is correctly enabled/disabled
            if (segments.length >= 2) {
                spinButton.disabled = false;
            } else {
                spinButton.disabled = true;
            }
            currentPrize = null; // Clear current prize if not logged
            currentPrizeIndex = -1;
        });
        confirmWinnerButton.addEventListener('click', logWinner);
        winnerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') logWinner();
        });
        clearWinnersButton.addEventListener('click', clearWinnersLog);

        window.addEventListener('click', function(event) {
            if (event.target == winnerModal) {
                winnerModal.style.display = "none";
                if (segments.length >= 2) spinButton.disabled = false; else spinButton.disabled = true;
                currentPrize = null; 
                currentPrizeIndex = -1;
            } else if (event.target == confirmationModal) {
                confirmationModal.style.display = "none";
                currentConfirmAction = null; 
            }
        });

        // --- Initial Setup ---
        loadConfiguration();  
        loadTheme();          
        resizeCanvas();       

        if (segments.length === 0 && !localStorage.getItem('wheelSegments')) { 
            segments = [
                { text: "Prize A", color: getSegmentColor(0) }, { text: "Spin Again", color: getSegmentColor(1) },
                { text: "Bonus", color: getSegmentColor(2) }, { text: "Big Prize!", color: getSegmentColor(3) },
                { text: "Try Next Time", color: getSegmentColor(4)}, { text: "Small Win", color: getSegmentColor(5)}
            ];
        }
        if (segments.length < 2) {
            spinButton.disabled = true;
        } else {
            spinButton.disabled = false;
        }
        renderSegmentList(); 
        renderWinnersList(); 
        drawWheel(); 

    </script>
</body>
</html>
